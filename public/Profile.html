<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>UmtuWam</title>
    <link rel="stylesheet" href="./Profile.css" type="text/css">
</head>

<body>
    <script>
        window.onload = function () {
            var did = new URL(location.href).searchParams.get("did");
            id.setAttribute("value", did);
            image.setAttribute("href", `https://us-central1-umtuwam.cloudfunctions.net/http-getImageView?id=${did}`)
            fetch(`https://us-central1-umtuwam.cloudfunctions.net/http-getUserInformation?id=${did}`)
                .then(res => res.json())
                .then((out) => {
                    myName.setAttribute("value", out.name);
                    age.setAttribute("value", out.age);
                    bio.setAttribute("value", out.bio);
                    membership.setAttribute("href", `https://us-central1-umtuwam.cloudfunctions.net/http-getMembershipXml?id=${did}`);

                    var whereabouts = document.getElementById("whereabouts").children;
                    for (var i = 0; i < whereabouts.length; i++) {
                        if (whereabouts[i].value == out.location) {
                            whereabouts[i].selected = true;
                            break;
                        }
                    }
                }).catch(err => console.error(err));
        }
        function stop() {
            event.preventDefault();
            var url = `https://us-central1-umtuwam.cloudfunctions.net/http-updateUserInformation?` +
            `name=${myName.value}` +
            `&age=${age.value}` +
            `&location=${whereabouts.value}` +
            `&bio=${bio.value}` +
            `&id=${id.value}`;

            checkBtn.disabled = true;
            checkBtn.innerText = 'Loading...'
            fetch(url).then(function (response) {
                console.log(response);
                checkBtn.innerText = 'Changes saved!';
                let timeout = setTimeout(reset, 3000);
                return response.json();
            }).catch(err => console.error(err));
        }
        function reset() {
            checkBtn.disabled = false;
            checkBtn.innerText = 'Save changes'
        }
    </script>
    <div>
        <hr>
        <h2>Your profile - make it complete!</h2>
        <hr>
    </div>
    <form id="form" onsubmit="stop();" method="get">
        <div class="container">
            <p>
                <label>Name:
                    <br />
                    <input type="text" id="myName" name="myName" pattern="^([A-Za-z]+[,.]?[ ]?|[A-Za-z]+['-]?)+$"
                        maxlength="50" required>
                </label>
            </p>
            <p>
                <label>Age:
                    <br />
                    <input type="text" id="age" name="age" pattern="[0-9]+" maxlength="3" required>
                </label>
            </p>
            <p>
                <label>Location:
                    <select name="whereabouts" id="whereabouts" required>
                        <option value="" disabled selected>Select your location</option>
                        <option value="Bloemfontein">Bloemfontein</option>
                        <option value="Cape Town">Cape Town</option>
                        <option value="Durban">Durban</option>
                        <option value="Johannesburg">Johannesburg</option>
                        <option value="Kimberley">Kimberley</option>
                        <option value="Nelspruit">Nelspruit</option>
                        <option value="PE">PE</option>
                        <option value="Polokwane">Polokwane</option>
                        <option value="Pretoria">Pretoria</option>
                        <option value="Soweto">Soweto</option>
                    </select>
                </label>
            </p>
            <p>
                <label>About me:
                    <br />
                    <textarea class="bio" id="bio" maxlength="255" name="bio" rows="5"></textarea>
                </label>
            </p>
            <input type="text" id="id" name="id" hidden value="" />
        </div>

        <a href="" id="image" class="btn">Add your photos</a>
        <a href="" id="membership" class="btn membership">Membership (chat and more)</a>
        <button type="submit" id="checkBtn">Save changes</button>
    </form>
</body>

</html>